(* =========================================================
	Sophia (AI₂O³) - BNF Grammar Definition v1.6.6
	"The Determinism Update"
	
	Philosophy:
		- Auto-Iteration: Universal iteration source support
		- O(N) Enforcement: Nested loops forbidden
		- Zero-Offset-Error: Range-based indexing
		- Physicality: Array, I/O Gate, and Lens models
		- Determinism: Side-effect-free expression via Pure Functions
	
	Update History:
		v1.6.1: Universal IterSource (LValue + Literal + Range)
		v1.6.4: I/O Gate Model ([?],[_],[<],[>]), Try-Flow (?!), Exit Controls
		v1.6.5: Lens Selectors (]>[ |>[ [>[), Namespace SysCalls ($[sys...])
		v1.6.6: Pure Functions (!) and Task (&) separation for guaranteed determinism.
	========================================================= *)

(* =========================================================
	PROGRAM STRUCTURE
	========================================================= *)

<Program>		::= <Definition>*

<Definition>	::= <SchemaDef> 
				| <TaskDef>      (* 副作用あり: & *)
				| <PureDef>      (* 副作用なし: ! *)
				| <SceneDef> 
				| <ConstDef>

(* =========================================================
	SCHEMA DEFINITION (テーブル構造定義)
	========================================================= *)

<SchemaDef>		::= "#" <Ident> <FieldsBlock> <CapacityBlock>?

<FieldsBlock>	::= "[" <TypedFields> "]"
<TypedFields>	::= <FieldDef> ( "," <FieldDef> )*
<FieldDef>		::= <Ident> ":" <Type>

<Type>			::= "i8" | "i16" | "i32" | "u8" | "u16" | "u32" 
				| "f32" | "f64" | "str" | "bool"

<CapacityBlock>	::= "[" ( <Int> | <Ident> ) "]"

(* =========================================================
	CONSTANT DEFINITION (ハッシュマップ型定数)
	========================================================= *)

<ConstDef>		::= "%" <Ident> "[" <HashList> "]"
<HashList>		::= <HashPair> ( "," <HashPair> )*
<HashPair>		::= <Ident> ( ":" <Expression> )?

(* =========================================================
	SCENE DEFINITION (物理レンズモデル)
	========================================================= *)

<SceneDef>		::= "scene" <Ident> <LensSelector> "[" <EventDef>* "]"

<LensSelector>	::= "]>["  (* Wide Lens: Global/Base Layer   *)
				| "|>["  (* Normal Lens: Active/Main Layer *)
				| "[>["  (* Tele Lens: Overlay/Sub Layer   *)

<EventDef>		::= "on" <Ident> <ArgParamList>? <BodyBlock>

<ArgParamList>	::= "[" ( "." <Ident> ( "," "." <Ident> )* )? "]"

(* =========================================================
	TASK & PURE FUNCTION DEFINITION (タスクと純粋関数)
	========================================================= *)

<TaskDef>		::= "&" <Ident> "[" <ParamList>? "]" <BodyBlock>
<PureDef>		::= "!" <Ident> "[" <ParamList>? "]" <BodyBlock>
<ParamList>		::= <Ident> ( "," <Ident> )*

(* =========================================================
	STATEMENTS & FLOW CONTROL (実行文と制御)
	========================================================= *)

<BodyBlock>		::= "[" <Statement>* <ExitControl>? "]"

<Statement>		::= <IterateBlock>
				| <CollectionBlock>
				| <ListBlock>
				| <QAChain>
				| <Action>
				| <SapphireCall>
				| <TaskCall>
				| <ExitControl>

(* --- QA CHAIN & TRY-FLOW --- *)
<QAChain>		::= <QPrefix> <BodyBlock> ( <ElseIfBlock> | <ElseBlock> )?

<QPrefix>		::= "?" "[" <Expression> "]"         (* If: 条件評価 *)
				| "?!"                               (* Try: 実行成否評価 *)

<ElseIfBlock>	::= "|?" <QAChain>
<ElseBlock>		::= "|!" ( "[" <Ident> "]" )? <BodyBlock> (* Catch/Else *)

(* --- SAPPHIRE CALL & I/O GATES (Namespaces) --- *)
<SapphireCall>	::= "$" "[" <Namespace> "." <Ident> <ArgList>? "]" <IOGate>?

<Namespace>		::= "scene" | "event" | "audio" | "net" | "ui" | "sys" | "math" | "file"

<IOGate>		::= "[" <IOParts> "]"
<IOParts>		::= <IOPart> ( "," <IOPart> )*
<IOPart>		::= "?" <Expression>                 (* 条件フィルタ (Status等) *)
				| "_" <Expression>                 (* 待機時間 (Timeout) *)
				| "<"                              (* Read (受信/同期化) *)
				| ">" <Expression>?                (* Write (送信/イベント発火) *)
				| "x"                              (* Abort (切断) *)

(* --- EXIT CONTROL (End-Cap & Out-Gate) --- *)
<ExitControl>	::= <EndCap> | <OutGate>

<EndCap>		::= "^" <Int>?                       (* Continue/Retry (limit) *)
				| "v"                                (* Pass/Next *)
				| "x"                                (* Break/Terminate *)

<OutGate>		::= ">" <Expression>?                (* Return/Output/Signal *)

(* =========================================================
	ITERATION & COLLECTION
	========================================================= *)

<IterateBlock>	::= <IterSource> "*" <BodyBlock>

<IterSource>	::= <LValue>                         (* Array, Table, Variable *)
				| <ListBlock>                        (* Array slice: arr@[0:10] *)
				| <Int>                              (* N-times loop *)
				| <Range>                            (* Range: start:end *)
				| "(" <Expression> ")"               (* Expression result *)

<Range>			::= <Expression> ":" <Expression>

<CollectionBlock> ::= <Ident> "#" <Subject> <BodyBlock>?
<Subject>		::= <Int> | <Ident> | "*"

<ListBlock>		::= <Ident> "@" "[" <Range>? <GateOp> <Expression>? "]"
<GateOp>		::= "<" | ">" | "x" | "^" | "v" | "size"

(* =========================================================
	LVALUE & CALLS
	========================================================= *)

<LValue>		::= <Nature> <Ident> <SubAccess>*
<SubAccess>		::= "::" <Ident>                     (* Property access *)
				| "%" <Ident>                        (* Hash key access *)
				| "#" <Expression>                   (* Table index access *)

<Nature>		::= "#" | "%" | "@" | "$" | "&" | "." | "~"

<DirectAccess>	::= <Accessor> <Ident>
<Accessor>		::= "::" | "%" | "#"

<TaskCall>		::= <Ident> "&" "[" <ArgList>? "]"
<PureCall>		::= <Ident> "!" "[" <ArgList>? "]"
<ArgList>		::= <Expression> ( "," <Expression> )*

(* =========================================================
	ACTIONS & OPERATIONS (演算・代入)
	========================================================= *)

<Action>		::= <LValue> "[" <GeoOp> <Expression>? "]"
				| <DirectAccess> "[" <GeoOp> <Expression>? "]"

<GeoOp>			::= "<" | ">" | "x" | "+" | "-" | "*" | "/" | "%" 
				| "^" | "v" | "_"

(* =========================================================
	EXPRESSIONS & LITERALS (式とリテラル)
	========================================================= *)

<Expression>	::= <LogicalOR>
<LogicalOR>		::= <LogicalAND> ( "or" <LogicalAND> )*
<LogicalAND>	::= <Comparison> ( "and" <Comparison> )*

<Comparison>	::= <MathExpr> ( <CompOp> <MathExpr> )*
<CompOp>		::= "eq" | "ne" | "gt" | "lt" | "ge" | "le"

<MathExpr>		::= <Term> ( ( "+" | "-" ) <Term> )*
<Term>			::= <Factor> ( ( "*" | "/" | "%" ) <Factor> )*
<Factor>		::= <Unary> | <Primary>
<Unary>			::= ( "!" | "-" ) <Primary>

<Primary>		::= <Literal> 
				| <LValue> 
				| <DirectAccess> 
				| <PureCall>      (* Expression内では ! のみを許可 *)
				| <SapphireCall> 
				| "(" <Expression> ")"

<Literal>		::= <Int> | <Float> | <String> | <Bool>
<Int>			::= [0-9]+
<Float>			::= [0-9]+ "." [0-9]+
<String>		::= "\"" [^"]* "\""
<Bool>			::= "true" | "false"

<Ident>			::= [a-zA-Z_][a-zA-Z0-9_]*
